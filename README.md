# Maliva: Using Machine Learning to Rewrite Visualization Queries Under Time Constraints
This repository hosts the source code of the paper `Maliva` submitted to VLDB 2022.

We provide a [Tutorial](https://github.com/malivamlvis/maliva/wiki) to run Maliva on top of PostgreSQL hosting 15 million NYC Taxi data.

Maliva is a middleware that optimizes visualization queries to compute results within a time constraint. It adopts Machine Learning techniques to add `hints` to the original SQL queries to help the database optimizer generate an efficient physical plan.

<p align="center">
  <img src="https://github.com/malivamlvis/maliva/blob/main/pub/intro-slow-query.png" width="175">
  <img src="https://github.com/malivamlvis/maliva/blob/main/pub/intro-fast-query.png" width="175">
</p>

For expensive visualization queries that can not meet the time constraint no matter what hints are provided, Maliva also considers rewriting the original SQL query by applying approximation rules, e.g., running the same query on a smaller sample table.  In this case, Maliva jointly maximizes the chance of an approximate rewritten query meeting the time constraint and also quality of the approximate result.

<p align="center">
  <img src="https://github.com/malivamlvis/maliva/blob/main/pub/intro-slow-query2.png" width="175">
  <img src="https://github.com/malivamlvis/maliva/blob/main/pub/intro-fast-query2.png" width="175">
</p>

The following figure shows the architecture of Maliva.

<p align="center">
  <img src="https://github.com/malivamlvis/maliva/blob/main/pub/architecture.png" width="300">
</p>

The core module is the `MDP-based Query Rewriter`. It enumerates different possible rewrite options (i.e., query hints and/or approximation rules), asks the `Query Time Estimator (QTE)` to estimate the query time for each considered rewritten query, and then decides one rewritten query as the output. The Query Rewriter models the sequential decision-making of which rewritten query to estimate as a Markov Decision Process. It learns a good strategy from historical queries to balance the planning time and the querying time.

<p align="center">
  <img src="https://github.com/malivamlvis/maliva/blob/main/pub/maliva-vs-postgresql.png" width="558">
</p>

The experiment results show that for 100 Million tweets dataset, for "hard" workloads where each query has only one viable plan (i.e. only one physical plan can meet the time budget requirement), Maliva using both an Accurate QTE and an Approximate QTE outperformed the original query plan generated by PostgreSQL significantly. The metric `Viable Query Percentage (%)` means that for an approach, how many of the generated hinted queries by Maliva (or physical plans by PostgreSQL) were `viable`, where viable means the total query response time was within the given time budget (e.g., 500 ms)
